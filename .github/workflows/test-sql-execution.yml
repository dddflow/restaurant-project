name: Test SQL Execution on Oracle XE

on:
  pull_request:

jobs:
  test-sql:
    runs-on: ubuntu-latest
    services:
      oracle:
        image: gvenzl/oracle-xe:21-slim
        ports:
          - 1521:1521
        env:
          ORACLE_PASSWORD: testpass
          APP_USER: test
          APP_USER_PASSWORD: test

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ•’ Wait for Oracle to initialize
        run: sleep 40  # Oracle XE Ð¿Ð¾Ð´Ð½Ð¸Ð¼Ð°ÐµÑ‚ÑÑ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾

      - name: ðŸ§ª Run SQL files manually (strict order)
        run: |
          docker_id=$(docker ps -q --filter ancestor=gvenzl/oracle-xe:21-slim)
          echo "ðŸŸ¢ Running: create_tables.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat sql/create_tables.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"

          echo "ðŸŸ¢ Running: insert_values.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat sql/insert_values.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"

          echo "ðŸŸ¢ Running: queries.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat sql/queries.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"
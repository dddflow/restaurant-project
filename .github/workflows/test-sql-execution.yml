name: Test SQL Execution on Oracle XE

on:
  pull_request:

jobs:
  test-sql:
    runs-on: ubuntu-latest
    services:
      oracle:
        image: gvenzl/oracle-xe:21-slim
        ports:
          - 1521:1521
        env:
          ORACLE_PASSWORD: testpass
          APP_USER: test
          APP_USER_PASSWORD: test

    steps:
      - name: 游닌 Checkout repository
        uses: actions/checkout@v4

      - name: 游 Wait for Oracle to initialize
        run: sleep 40  # Oracle XE 쮏얧쫧쟳쨿썛왐혜혪 햪햣햢햩햣햫햫

      - name: 游닌 Copy SQL files into container
        run: |
          docker_id=$(docker ps -q --filter ancestor=gvenzl/oracle-xe:21-slim)
          docker cp sql/. $docker_id:/sql

      - name: 游빍 Run SQL files manually (strict order)
        run: |
          docker_id=$(docker ps -q --filter ancestor=gvenzl/oracle-xe:21-slim)
          echo "游릭 Running: create_tables.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat /sql/create_tables.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"

          echo "游릭 Running: insert_values.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat /sql/insert_values.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"

          echo "游릭 Running: queries.sql"
          docker exec $docker_id bash -c "echo 'WHENEVER SQLERROR EXIT SQL.SQLCODE;' > temp.sql && cat /sql/queries.sql >> temp.sql && sqlplus system/oracle@XE @temp.sql"